INCLUDES += hal

../include/%.h: ./hal/%.h
	cp $^ $@


HALLIBSRCS := \
	hal/hal_lib.c \
	rtapi/rtapi_compat.c \
	rtapi/rtapi_support.c 

ifeq ($(THREADS),xenomai-kernel)
XENO_LINK := $(shell $(XENO_CONFIG)  --skin=native --ldflags )
else
XENO_LINK=
endif

$(call TOOBJSDEPS, $(HALLIBSRCS)): EXTRAFLAGS += -fPIC

# Add to list of sources to compile -DULAPI ->
# objects/{rtapi/*.o,hal/hal_lib.o}
USERSRCS += $(HALLIBSRCS)

HALLIB := ../lib/liblinuxcnchal.so

$(HALLIB).0: $(call TOOBJS, $(HALLIBSRCS))
	$(ECHO) Creating shared library $(notdir $@)
	@mkdir -p ../lib
	@rm -f $@
	$(Q)$(CC) $(LDFLAGS)  -Wl,-soname,$(notdir $@) -shared \
	    -o $@ $^ -ldl $(RT_LDFLAGS)

HALMODULESRCS := hal/halmodule.cc
PYSRCS += $(HALMODULESRCS)

HALMODULE := ../lib/python/_hal.so
$(HALMODULE): $(call TOOBJS, $(HALMODULESRCS)) $(HALLIB)
	$(ECHO) Linking python module $(notdir $@)
	$(Q)$(CXX) $(LDFLAGS) -shared -o $@ $^ 


RINGMODULESRCS := hal/ringmodule.cc
PYSRCS += $(RINGMODULESRCS)

RINGMODULE := ../lib/python/ring.so

# TODO: unifiy with boost.python configure support in master
BOOST_PYTHON_LIBS := -lboost_python

$(call TOOBJSDEPS, $(RINGMODULESRCS)): \
	EXTRAFLAGS += -fPIC $(shell python-config --cflags)

$(RINGMODULE): $(call TOOBJS, $(RINGMODULESRCS)) $(HALLIB)
	$(ECHO) Linking python module $(notdir $@)
	$(Q)$(CXX) $(LDFLAGS) -shared -o $@ $^ \
	$(BOOST_PYTHON_LIBS) \
	$(shell python-config --libs)  $(HALLIB)


# GROUPMODULESRCS := hal/groupmodule.cc
# PYSRCS += $(GROUPMODULESRCS)

# GROUPMODULE := ../lib/python/group.so

# TODO: unifiy with boost.python configure support in master
BOOST_PYTHON_LIBS := -lboost_python

$(call TOOBJSDEPS, $(GROUPMODULESRCS)): \
	EXTRAFLAGS += -fPIC $(shell python-config --cflags)

$(GROUPMODULE): $(call TOOBJS, $(GROUPMODULESRCS)) $(HALLIB)
	$(ECHO) Linking python module $(notdir $@)
	$(Q)$(CXX) $(LDFLAGS) -shared -o $@ $^ \
	$(BOOST_PYTHON_LIBS) \
	$(shell python-config --libs)  $(HALLIB)



TARGETS += $(HALLIB) ../lib/liblinuxcnchal.so.0
PYTARGETS += $(HALMODULE) $(RINGMODULE) $(GROUPMODULE)
